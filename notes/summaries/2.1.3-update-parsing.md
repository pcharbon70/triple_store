# Task 2.1.3: Update Parsing - Summary

## Overview

Implemented SPARQL UPDATE parsing support in the spargebra-based NIF parser. This enables parsing of all SPARQL 1.1 Update operations including INSERT DATA, DELETE DATA, DELETE/INSERT WHERE, LOAD, CLEAR, CREATE, and DROP.

## Implementation Details

### Rust NIF Changes (`native/sparql_parser_nif/src/lib.rs`)

Added `parse_update` NIF function that:
- Uses `spargebra::Update::parse()` for SPARQL UPDATE parsing
- Converts all 7 `GraphUpdateOperation` variants to Elixir terms
- Handles quads (triples with graph context) for named graph operations
- Returns `{:ok, ast}` or `{:error, {:parse_error, message}}`

New atoms added for UPDATE operations:
- Operation types: `update`, `insert_data`, `delete_data`, `delete_insert`, `load`, `clear`, `create`, `drop`
- Graph targets: `default_graph`, `named_graph`, `all_graphs`, `all_named`
- Quad support: `quad`

Key conversion functions implemented:
- `update_to_term()` - Main UPDATE AST conversion
- `graph_update_operation_to_term()` - Converts each operation variant
- `quad_to_term()` / `ground_quad_to_term()` - Quad pattern handling
- `graph_target_to_term()` - Graph target specification
- Subject/predicate/object converters for quad components

### Elixir Module Changes

**`lib/triple_store/sparql/parser/nif.ex`**:
- Added `parse_update/1` NIF binding

**`lib/triple_store/sparql/parser.ex`**:
- Added `parse_update/1` and `parse_update!/1` public functions
- Added `update?/1` type checking helper
- Added `get_operations/1` helper to extract operations from UPDATE AST
- Updated moduledoc with UPDATE examples

### Test Coverage

Added 33 new tests covering:
- Basic `parse_update/1` and `parse_update!/1` API
- `update?/1` and `get_operations/1` helpers
- INSERT DATA (single/multiple triples, literals, named graphs)
- DELETE DATA operations
- DELETE WHERE / INSERT WHERE / DELETE INSERT WHERE
- LOAD, LOAD SILENT, LOAD INTO GRAPH
- CLEAR ALL/DEFAULT/NAMED/GRAPH, CLEAR SILENT
- DROP GRAPH, CREATE GRAPH, CREATE SILENT
- Multiple operations separated by semicolon
- PREFIX support in UPDATE queries

## AST Structure

UPDATE operations return:
```elixir
{:update, [{"operations", [operation1, operation2, ...]}]}
```

Each operation is a tagged tuple:
```elixir
# INSERT DATA
{:insert_data, [quad1, quad2, ...]}

# DELETE DATA
{:delete_data, [quad1, quad2, ...]}

# DELETE/INSERT WHERE
{:delete_insert, %{
  "delete" => [patterns...],
  "insert" => [patterns...],
  "pattern" => where_pattern
}}

# LOAD
{:load, %{"source" => uri, "destination" => graph_or_nil, "silent" => boolean}}

# CLEAR
{:clear, %{"target" => graph_target, "silent" => boolean}}

# CREATE/DROP
{:create, %{"target" => {:named_graph, uri}, "silent" => boolean}}
{:drop, %{"target" => graph_target, "silent" => boolean}}
```

## Test Results

All 108 tests pass (75 existing + 33 new UPDATE tests).

## Challenges Resolved

1. **Module path**: `GraphUpdateOperation` is at `spargebra::GraphUpdateOperation`, not in the `algebra` submodule
2. **Type distinctions**: Quads use `Subject`/`Term` while QuadPatterns use `TermPattern` - required separate conversion functions
3. **GroundQuadPattern predicate**: Uses `NamedNodePattern`, not `NamedNode`
4. **NIF registration**: Required explicit function list in `rustler::init!` macro

## Files Changed

- `native/sparql_parser_nif/src/lib.rs` - Added parse_update NIF and conversion functions
- `lib/triple_store/sparql/parser/nif.ex` - Added parse_update binding
- `lib/triple_store/sparql/parser.ex` - Added public API functions and helpers
- `test/triple_store/sparql/parser_test.exs` - Added 33 UPDATE parsing tests
