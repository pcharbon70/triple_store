# Task 2.2.3: Expression Compilation

## Summary

Implemented the SPARQL expression evaluation module that compiles and evaluates SPARQL expressions from parsed AST. Expressions appear in FILTER clauses, BIND expressions, SELECT projections, and aggregate functions.

## Implementation Details

### Files Created

- `lib/triple_store/sparql/expression.ex` - Expression evaluator module (~1150 lines)
- `test/triple_store/sparql/expression_test.exs` - Comprehensive test suite (112 tests)

### Expression Types Implemented

#### Arithmetic Expressions (2.2.3.1)
- `:add` - Addition (+)
- `:subtract` - Subtraction (-)
- `:multiply` - Multiplication (*)
- `:divide` - Division (/)
- `:unary_minus` - Unary negation (-)
- Type promotion: integer → decimal → float → double

#### Comparison Expressions (2.2.3.2)
- `:equal` - Equality (=)
- `:greater` - Greater than (>)
- `:less` - Less than (<)
- `:greater_or_equal` - Greater or equal (>=)
- `:less_or_equal` - Less or equal (<=)
- Numeric and string comparison supported

#### Logical Expressions (2.2.3.3)
- `:and` - Logical AND (&&)
- `:or` - Logical OR (||)
- `:not` - Logical NOT (!)
- Effective boolean value for non-boolean types

#### Built-in Functions (2.2.3.4)
- **Term Accessors**: STR, LANG, DATATYPE, IRI/URI, BNODE
- **Type Checking**: ISIRI/ISURI, ISBLANK, ISLITERAL, ISNUMERIC, BOUND
- **String Functions**: STRLEN, SUBSTR, UCASE, LCASE, STRSTARTS, STRENDS, CONTAINS, STRBEFORE, STRAFTER, ENCODE_FOR_URI, CONCAT, LANGMATCHES, REGEX, REPLACE
- **Numeric Functions**: ABS, ROUND, CEIL, FLOOR, RAND
- **Date/Time Functions**: NOW, YEAR, MONTH, DAY, HOURS, MINUTES, SECONDS, TIMEZONE, TZ
- **Hash Functions**: MD5, SHA1, SHA256, SHA384, SHA512

#### Aggregate Functions (2.2.3.5)
- `:count` - COUNT (with DISTINCT support)
- `:sum` - SUM
- `:avg` - AVG
- `:min` - MIN
- `:max` - MAX
- `{:group_concat, separator}` - GROUP_CONCAT (with optional separator)
- `:sample` - SAMPLE

#### Conditional Expressions
- `:if_expr` - IF(condition, then, else)
- `:coalesce` - COALESCE(expr1, expr2, ...)
- `:in_expr` - expr IN (val1, val2, ...)
- `:exists` - EXISTS (placeholder - requires executor context)

### Core API

```elixir
# Evaluate expression against variable bindings
Expression.evaluate(expr, bindings)
# => {:ok, rdf_term} | :error

# Evaluate aggregate over group of solutions
Expression.evaluate_aggregate(aggregate, solutions)
# => {:ok, rdf_term} | :error

# Analysis functions
Expression.expression_variables(expr)  # => [variable_names]
Expression.is_constant?(expr)          # => boolean
Expression.expression_type(expr)       # => :arithmetic | :comparison | ...
```

### Parser Integration

The module evaluates expression AST nodes as produced by the spargebra parser:

```elixir
# Parser produces:
{:and,
  {:greater, {:variable, "y"}, {:literal, :typed, "10", @xsd_integer}},
  {:less, {:variable, "y"}, {:literal, :typed, "20", @xsd_integer}}
}

# Expression.evaluate with bindings returns:
{:ok, {:literal, :typed, "true", @xsd_boolean}}
```

## Test Coverage

112 new tests covering:
- Variable and literal evaluation
- All arithmetic operations with type promotion
- All comparison operators with numeric/string values
- Logical operators with effective boolean value
- BOUND function
- STR, LANG, DATATYPE functions
- Type checking functions (ISIRI, ISBLANK, ISLITERAL, ISNUMERIC)
- String functions (STRLEN, SUBSTR, UCASE, LCASE, STARTS/ENDS/CONTAINS, etc.)
- Numeric functions (ABS, ROUND, CEIL, FLOOR, RAND)
- Date/time functions (NOW, YEAR, MONTH, DAY, etc.)
- Hash functions (MD5, SHA1, SHA256, SHA384, SHA512)
- Conditional expressions (IF, COALESCE, IN)
- IRI and BNODE functions
- All aggregate functions (COUNT, SUM, AVG, MIN, MAX, GROUP_CONCAT, SAMPLE)
- Expression analysis functions
- Parser integration tests
- Edge cases and error handling

## Dependencies

No new dependencies. Uses Elixir standard library (:crypto, :rand, DateTime, URI, Regex).

## Notes

- EXISTS evaluation requires access to the data store, which will be handled at the query executor level
- Unknown functions return `{:error, "Unknown function: NAME"}` to allow future extension
- Division by zero returns `:error`
- Unbound variables return `:error`
- Language tag matching follows BCP47 rules (prefix matching with `-`)

## Next Steps

Task 2.2.4: Unit Tests - The task plan lists tests for algebra nodes, but these are already covered in tasks 2.2.1-2.2.3. This section can be marked complete.

Then proceed to Section 2.3: Query Optimization (filter push-down, constant folding, BGP reordering).
