# Task 2.7.1: Query Pipeline Integration Tests

## Summary

Implemented comprehensive integration tests for the SPARQL query pipeline, validating end-to-end execution from SPARQL string parsing through query execution to result materialization.

## Files Modified

- `test/triple_store/sparql/query_test.exs` - Added 6 new integration tests and helper function

## Tests Added

### 2.7.1.1 - Simple SELECT with Single Pattern

Tests basic query execution with a single triple pattern:
```sparql
SELECT ?name
WHERE { <http://example.org/Alice> <http://xmlns.com/foaf/0.1/name> ?name }
```

Validates:
- Single pattern matching works correctly
- Results are properly bound and returned

### 2.7.1.2 - SELECT with Star Query (Multiple Patterns)

Tests star query pattern where multiple patterns share the same subject variable:
```sparql
SELECT ?s ?name ?age
WHERE {
  ?s <http://ex.org/name> ?name .
  ?s <http://ex.org/age> ?age
}
```

Validates:
- Join operations work correctly
- Multiple bindings per subject are handled
- All matching results are returned

### 2.7.1.3 - SELECT with OPTIONAL Producing Nulls

Tests LEFT JOIN semantics where optional patterns may not match:
```sparql
SELECT ?name ?email
WHERE {
  ?s <http://ex.org/name> ?name
  OPTIONAL { ?s <http://ex.org/email> ?email }
}
```

Validates:
- OPTIONAL patterns return bindings when matched
- Missing optional bindings result in null/unbound values
- Required patterns still filter correctly

### 2.7.1.4 - SELECT with UNION Combining Branches

Tests UNION operator combining results from alternative patterns:
```sparql
SELECT ?entity ?type
WHERE {
  { ?entity <http://ex.org/type> ?type }
  UNION
  { ?entity <http://ex.org/rdf_type> ?type }
}
```

Validates:
- Both branches are evaluated
- Results from all branches are combined
- No duplicate elimination (per SPARQL semantics)

### 2.7.1.5 - SELECT with Complex FILTER Expressions

Tests compound FILTER expressions with comparison operators:
```sparql
SELECT ?product ?price
WHERE {
  ?product <http://ex.org/price> ?price
  FILTER(?price >= 40 && ?price <= 100)
}
```

Validates:
- Numeric comparisons work correctly
- Logical AND (&&) combines conditions
- Typed literals are compared properly

### 2.7.1.6 - SELECT with ORDER BY, LIMIT, OFFSET Combined

Tests solution modifiers working together:
```sparql
SELECT ?item ?value
WHERE {
  ?item <http://ex.org/value> ?value
}
ORDER BY DESC(?value)
LIMIT 3
OFFSET 2
```

Validates:
- ORDER BY sorts results correctly (ascending/descending)
- OFFSET skips the correct number of results
- LIMIT restricts output count
- Modifiers apply in correct order (ORDER BY → OFFSET → LIMIT)

## Helper Function Added

```elixir
defp add_typed_triple(db, manager, {s_term, p_term, {:literal, :typed, value, type}})
```

Supports adding triples with typed literals (e.g., xsd:integer) for numeric comparison tests.

## Test Coverage Summary

| Test ID | Description | Status |
|---------|-------------|--------|
| 2.7.1.1 | Simple SELECT with single pattern | ✅ |
| 2.7.1.2 | Star query with multiple patterns | ✅ |
| 2.7.1.3 | OPTIONAL producing nulls | ✅ |
| 2.7.1.4 | UNION combining branches | ✅ |
| 2.7.1.5 | Complex FILTER expressions | ✅ |
| 2.7.1.6 | ORDER BY, LIMIT, OFFSET combined | ✅ |

## Pre-existing Tests

Many pipeline tests already existed in query_test.exs before this task:
- Basic SELECT query execution
- ASK query execution
- CONSTRUCT query execution
- DESCRIBE query execution
- Streaming query support
- Prepared query execution
- Various solution modifiers

The new tests specifically target the integration requirements outlined in Task 2.7.1, providing clear traceability to the plan.

## Total Test Count

- Before: 1673 tests
- After: 1679 tests (+6 integration tests)

## Notes

- All tests use isolated temporary databases to avoid interference
- Tests clean up resources properly via `cleanup/1` helper
- Tests are tagged with `@describetag :integration` for selective execution
