# Task 2.1.4: Error Handling - Summary

## Overview

Implemented comprehensive error handling for the SPARQL parser with line/column position reporting, descriptive error messages, prefix resolution error detection, and variable scoping validation.

## Implementation Details

### New Functions

Added to `lib/triple_store/sparql/parser.ex`:

1. **`parse_with_details/1`** - Parse query with structured error information
2. **`parse_update_with_details/1`** - Parse UPDATE with structured error information
3. **`format_error/2`** - Format error into human-readable string with context
4. **`build_error_details/3`** - Internal helper to construct error details (public for testing)

### Error Structure

The `parse_error` type contains:
```elixir
%{
  message: String.t(),      # Human-readable error description
  line: pos_integer() | nil,  # Line number (1-indexed)
  column: pos_integer() | nil,  # Column number (1-indexed)
  raw_message: String.t(),  # Original parser error message
  hint: String.t() | nil    # Helpful suggestion for fixing the error
}
```

### Task 2.1.4.1: Line/Column Position

- Extracts position from spargebra error format `"error at LINE:COLUMN: ..."`
- Works with multiline queries
- Returns `nil` for line/column if position not available in error message

### Task 2.1.4.2: Descriptive Error Messages

Improved messages for common mistakes:

| Error Type | Original (spargebra) | Improved Message |
|------------|---------------------|------------------|
| Invalid query form | `expected CONSTRUCT` | "Invalid query form. Expected SELECT, CONSTRUCT, ASK, or DESCRIBE" |
| Missing WHERE | `expected one of "{", DISTINCT` | "Missing WHERE clause or opening brace '{'" |
| Incomplete triple | `expected one of LATERAL, SERVICE, [_]` | "Incomplete triple pattern. A triple requires subject, predicate, and object" |
| Unclosed brace | Complex unicode ranges | "Unclosed brace. Expected '}' to close the pattern block" |

### Task 2.1.4.3: Prefix Resolution Errors

- Detects `"Prefix not found"` in spargebra error messages
- Provides descriptive message: "Undefined prefix. The prefix used in this query has not been declared"
- Generates helpful hints that:
  - Identify which prefix is undefined
  - Suggest common prefix declarations (rdf, rdfs, foaf, xsd)
  - Show example PREFIX syntax

### Task 2.1.4.4: Variable Scoping Validation

- Detects `"variable that is unbound"` errors from spargebra
- Provides descriptive message about variable scoping errors
- Generates context-aware hints:
  - For GROUP BY queries: explains that non-grouped variables must be in aggregates
  - For aggregate queries without GROUP BY: suggests adding GROUP BY clause

### Helper Functions

Added internal helpers:
- `extract_position/1` - Parse line:column from error string
- `extract_expected/1` - Extract expected tokens (handles multiline)
- `build_message/3` - Convert raw error to human-readable message
- `simplify_expected/2` - Clean up complex "expected one of" messages
- `generate_hint/3` - Generate context-aware hints
- `extract_undefined_prefix_hint/1` - Identify and suggest prefix declarations

## Example Output

```
Parse error at line 1, column 31: Undefined prefix. The prefix used in this query has not been declared
    SELECT ?s WHERE { ?s foaf:name ?name }
                                  ^

Hint: Add 'PREFIX foaf: <URI>' at the start of your query. Common prefixes:
  PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
  PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
  PREFIX foaf: <http://xmlns.com/foaf/0.1/>
  PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
```

## Test Coverage

Added 25 new tests covering:
- Line/column position extraction (6 tests)
- Descriptive error messages (5 tests)
- Prefix resolution errors (4 tests)
- Variable scoping validation (5 tests)
- format_error/2 helper (4 tests)

## Test Results

All 133 tests pass (108 existing + 25 new error handling tests).

## Files Changed

- `lib/triple_store/sparql/parser.ex` - Added error handling functions and helpers
- `test/triple_store/sparql/parser_test.exs` - Added Task 2.1.4 test suite

## Technical Notes

1. **Multiline regex handling**: The `extract_expected/1` function uses the `s` (dotall) flag to handle multiline error messages from spargebra

2. **Error detection order**: The `build_message/3` function checks for specific error patterns before falling through to generic handling. "Prefix not found" and "variable that is unbound" are checked first since they can appear inside "expected one of" messages.

3. **Backward compatibility**: The original `parse/1` and `parse_update/1` functions remain unchanged, returning the simple `{:error, {:parse_error, message}}` format. The new `*_with_details` functions provide enhanced error information.
